var Deferred = require( "../lib/jquery-deferred" ),
	jQuery = require( "../lib/jquery" );

exports[ "Deferred._Deferred()" ] = (function( ______ ) {

	______.expect( 11 );

	var deferred,
		object,
		test;

	deferred = Deferred._Deferred();

	test = false;

	deferred.done( function( value ) {
		______.equal( value , "value" , "Test pre-resolve callback" );
		test = true;
	} );

	deferred.resolve( "value" );

	______.ok( test , "Test pre-resolve callbacks called right away" );

	test = false;

	deferred.done( function( value ) {
		______.equal( value , "value" , "Test post-resolve callback" );
		test = true;
	} );

	______.ok( test , "Test post-resolve callbacks called right away" );

	deferred.cancel();

	test = true;

	deferred.done( function() {
		______.ok( false , "Cancel was ignored" );
		test = false;
	} );

	______.ok( test , "Test cancel" );

	deferred = Deferred._Deferred().resolve();

	try {
		deferred.done( function() {
			throw "Error";
		} , function() {
			______.ok( true , "Test deferred do not cancel on exception" );
		} );
	} catch( e ) {
		______.strictEqual( e , "Error" , "Test deferred propagates exceptions");
		deferred.done();
	}

	test = "";
	deferred = Deferred._Deferred().done( function() {

		test += "A";

	}, function() {

		test += "B";

	} ).resolve();

	______.strictEqual( test , "AB" , "Test multiple done parameters" );

	test = "";

	deferred.done( function() {

		deferred.done( function() {

			test += "C";

		} );

		test += "A";

	}, function() {

		test += "B";
	} );

	______.strictEqual( test , "ABC" , "Test done callbacks order" );

	deferred = Deferred._Deferred();

	deferred.resolveWith( jQuery , [ global ] ).done( function( doc ) {
		______.ok( this === jQuery && arguments.length === 1 && doc === global , "Test fire context & args" );
	});

	// #8421
	deferred = Deferred._Deferred();
	deferred.resolveWith().done(function() {
		______.ok( true, "Test resolveWith can be called with no argument" );
	});

	______.done();
});

exports[ "Deferred()" ] = (function( ______ ) {

	______.expect( 10 );

	Deferred( function( defer ) {
		______.strictEqual( this , defer , "Defer passed as this & first argument" );
		this.resolve( "done" );
	}).then( function( value ) {
		______.strictEqual( value , "done" , "Passed function executed" );
	});

	Deferred().resolve().then( function() {
		______.ok( true , "Success on resolve" );
	}, function() {
		______.ok( false , "Error on resolve" );
	});

	Deferred().reject().then( function() {
		______.ok( false , "Success on reject" );
	}, function() {
		______.ok( true , "Error on reject" );
	});

	( new Deferred( function( defer ) {
		______.strictEqual( this , defer , "Defer passed as this & first argument (new)" );
		this.resolve( "done" );
	}) ).then( function( value ) {
		______.strictEqual( value , "done" , "Passed function executed (new)" );
	});

	( new Deferred() ).resolve().then( function() {
		______.ok( true , "Success on resolve (new)" );
	}, function() {
		______.ok( false , "Error on resolve (new)" );
	});

	( new Deferred() ).reject().then( function() {
		______.ok( false , "Success on reject (new)" );
	}, function() {
		______.ok( true , "Error on reject (new)" );
	});

	var tmp = Deferred();

	______.strictEqual( tmp.promise() , tmp.promise() , "Test deferred always return same promise" );
	______.strictEqual( tmp.promise() , tmp.promise().promise() , "Test deferred's promise always return same promise as deferred" );

	______.done();
});

exports[ "Deferred.when()" ] = (function( ______ ) {

	______.expect( 23 );

	// Some other objects
	jQuery.each( {

		"an empty string": "",
		"a non-empty string": "some string",
		"zero": 0,
		"a number other than zero": 1,
		"true": true,
		"false": false,
		"null": null,
		"undefined": undefined,
		"a plain object": {}

	} , function( message , value ) {

		______.ok( "function" === jQuery.type( Deferred.when( value ).then( function( resolveValue ) {
			______.strictEqual( resolveValue , value , "Test the promise was resolved with " + message );
		} ).promise ) , "Test " + message + " triggers the creation of a new Promise" );

	} );

	______.ok( "function" === jQuery.type( Deferred.when().then( function( resolveValue ) {
		______.strictEqual( resolveValue , undefined , "Test the promise was resolved with no parameter" );
	} ).promise ) , "Test calling when with no parameter triggers the creation of a new Promise" );

	var cache, i;

	for( i = 1 ; i < 4 ; i++ ) {
		Deferred.when( cache || Deferred( function() {
			this.resolve( i );
		}) ).then( function( value ) {
			______.strictEqual( value , 1 , "Function executed" + ( i > 1 ? " only once" : "" ) );
			cache = value;
		}, function() {
			______.ok( false , "Fail called" );
		});
	}

	______.done();
});

exports[ "Deferred.when() - joined" ] = (function( ______ ) {

	______.expect(8);

	Deferred.when( 1, 2, 3 ).done( function( a, b, c ) {
		______.strictEqual( a , 1 , "Test first param is first resolved value - non-observables" );
		______.strictEqual( b , 2 , "Test second param is second resolved value - non-observables" );
		______.strictEqual( c , 3 , "Test third param is third resolved value - non-observables" );
	}).fail( function() {
		______.ok( false , "Test the created deferred was resolved - non-observables");
	});

	var successDeferred = Deferred().resolve( 1 , 2 , 3 ),
		errorDeferred = Deferred().reject( "error" , "errorParam" );

	Deferred.when( 1 , successDeferred , 3 ).done( function( a, b, c ) {
		______.strictEqual( a , 1 , "Test first param is first resolved value - resolved observable" );
		______.deepEqual( b , [ 1 , 2 , 3 ] , "Test second param is second resolved value - resolved observable" );
		______.strictEqual( c , 3 , "Test third param is third resolved value - resolved observable" );
	}).fail( function() {
		______.ok( false , "Test the created deferred was resolved - resolved observable");
	});

	Deferred.when( 1 , errorDeferred , 3 ).done( function() {
		______.ok( false , "Test the created deferred was rejected - rejected observable");
	}).fail( function( error , errorParam ) {
		______.strictEqual( error , "error" , "Test first param is first rejected value - rejected observable" );
		______.strictEqual( errorParam , "errorParam" , "Test second param is second rejected value - rejected observable" );
	});

	______.done();
});
